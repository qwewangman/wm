<?php

namespace app\index\controller;
use app\index\model\BorrowModel;
use app\index\model\EmigrationModel;
use think;
use think\Db;
use think\Route;
use app\index\controller\Base;
use TCPDF;
use app\index\model\FilewithinModel;


use app\index\model\StudentsModel;
use app\index\model\DepartmentModel;
use app\index\model\FileModel;
use app\index\model\LogModel;
use app\index\model\MajorModel;
use app\index\model\FileJoinModel;

class Change extends Base
{

    //获取列表
    public function getOut()
    {
        $d = new DepartmentModel();
        $dep = $d->getDepartList();//所有舞系
        $this->assign('departlist',$dep);
        return view('outlist');

    }

    //获取单一条数据
    public function getOutList()
    {
        $data   = input('param.');

        $f      = new EmigrationModel();
        $wzd    = $f->getList($data);

        $count  = $wzd['count'];

        $result = $wzd['content'];

        $result = array("code"=>0,"msg"=>"","count"=>$count,"data"=>$result,"page"=>$data['page']);
        echo json_encode($result);
    }

    //获取借阅列表
    public function getJie()
    {
        return view('jielist');

    }

    //获取单一条数据
    public function getJieList()
    {
        $data   = input('param.');

        $f      = new BorrowModel();
        $wzd    = $f->getList($data);

        $count  = $wzd['count'];

        $result = $wzd['content'];

        $doc_obj    = new FilewithinModel();
        foreach($result as &$v)
        {
            switch ($v['type'])
            {
                case 1:
                    $v['type']  = "普通借阅  ";
                    break;
                case 2:
                    $v['type']  = "室内查阅";
                    break;
                case 3:
                    $v['type']  = "在线查阅";
                    break;
            }
            $v['file_type']    = $v['docs']==0?"全卷借阅":"分文件借阅";
            $v['statuscon']    = $v['status']==1?"已归还":"借阅中";

            if($v['docs'] > 0)
            {
                $doc_arr    = explode(",",$v['docs']);
                $doc_list   = $doc_obj->getInfoByIds($doc_arr);

                $tmp_arr    = array();
                foreach ($doc_list AS $vv)
                {
                    $tmp_arr[]  = $vv['name'];
                }
                $v['docstr']  = implode("<br>",$tmp_arr);
            }else{
                $v['docstr']  = "全卷借阅";
            }
        }
        $result = array("code"=>0,"msg"=>"","count"=>$count,"data"=>$result,"page"=>$data['page']);
        echo json_encode($result);
    }

    //获取借阅列表
    public function setJieYue()
    {
        $data   = input('param.');
        $id         = $data['id'];
        $sid        = $data['sid'];
        $true_time  = $data['true_time'];
        $number     = $data['number'];

        $save_arr = array();
        $save_arr['true_time']  = $true_time;
        $save_arr['status']     = 1;
        $f      = new BorrowModel();
        $f->updateData($save_arr,$id);

        //写变动日志
        $admin_arr  = session('admin');
        $log_obj    = new LogModel();
        $save_data  = array();
        $save_data['stu_id']        = $sid;
        $save_data['act_id']        = $admin_arr['id'];
        $save_data['created_at']    = date("Y-m-d H:i:s");
        $save_data['name']          = "借阅归还";
        $save_data['before']        = "借阅号：".$number;
        $save_data['after']         = "案卷归还，归还时间：".$true_time;

        $log_obj->createData($save_data);

        $this->success("成功");

    }
}