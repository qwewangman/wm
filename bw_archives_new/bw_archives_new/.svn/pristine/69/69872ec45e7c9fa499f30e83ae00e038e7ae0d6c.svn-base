<?php
namespace app\index\controller;

use think;
use think\Db;
use think\Route;

use app\index\model\UserModel;
use think\Session;
use app\index\model\FilesModel;

class Index extends think\Controller
{
    public function index()
    {
         return $this->fetch();
    }

    public function login_do()
    {
        $data=input('param.');


        $name = $data['admin_name'];
        $pwd = $data['admin_pwd'];
        if(!captcha_check($data['verifyCode'])) {
            // 校验失败
            $this->error('验证码不正确');
        }

        $user_model = New UserModel();
        $arr = $user_model->getUser($name,$pwd);

        if(empty($arr))
        {
            $this->error('账号或密码有误');
            $url = url('/index');
        }else{
            Session::set('admin',$arr);
            $url = url('/home');
        }
        echo "<script> location.href='$url' </script>";
    }

    //首页
    public function home()
    {
        $uid = session('admin');
        if($uid == null){
            $url = url('/index');
            return $this->redirect($url);
        }

        $where = 'status in (1,2)';

        $dcl = Db::table('oa_students')->where('status',0)->count();
        $kc  = Db::table('oa_students')->where($where)->count();
        $bks  = Db::table('oa_students')->count();
        $this->assign('dcl',$dcl);
        $this->assign('kc',$kc);
        $this->assign('bks',$bks);
        return $this->fetch('home');
    }


    //用户退出
    public function login_out()
    {

        Session::delete('admin');
        $admin = session('admin');
        if(!isset($admin))
        {
            $url = url('/index');
            echo "<script> location.href='$url' </script>";
        }else{
            $this->error();
        }

    }




}
