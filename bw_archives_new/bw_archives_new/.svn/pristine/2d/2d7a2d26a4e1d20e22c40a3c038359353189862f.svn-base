<?php
/**
 * Created by PhpStorm.
 * User: 25352
 * Date: 2018/5/14
 * Time: 13:41
 */

namespace app\index\model;

use think\Model;
use think\Db;


class FileModel extends Model
{
    protected $table = 'oa_students';


    //未在档
    public function getStudentsList($data,$where,$type)
    {
        $num = $data['limit'];
        if($data['page']<=0) $data['page']=1;
        $p = ($data['page']-1)*$num;
        $lmt = "$p,".$num;
        if ($type == 1){
            $type = 'B%';
        }else{
            $type = 'Y%';
        }

        $arr = array();
        $arr['count'] = $this->where($where)->where('file_number like "'.$type.'"')->where('status != 3')->select();
        $arr['content'] = $this->where($where)->where('file_number like "'.$type.'"')->where('status != 3')->order('id','desc')->limit($lmt)->select();
        return $arr;

    }

    public function getFilesOnce($id)
    {
        //oa_students学生表  department院系表  major专业  oa_file_within文件表  s_id是关联的学生id  within_time是文件的形成时间
        $student      = Db::query('select * from oa_students as s JOIN department as d on s.courtyard = d.id join major as m on s.major = m.id  where s.id="'.$id.'"');        //获取卷号学生基本信息
        $stu_info = Db::table('oa_students')->where('id',$id)->find();
        $file_within  = Db::query('select * from oa_file_within  where  file_number ="'.$stu_info['file_number'].'" ORDER BY within_time  asc');                                                                             //获取卷内文件
//      $bdjl         = Db::query('select * from oa_change as ch LEFT JOIN oa_mailing as m on ch.out_company = m.files_number where s_id = "'.$file_number.'" order by create_time asc ');    //获取状态记录(时间排序)

        $result = array('stu'=>$student,'fw'=>$file_within);
        return $result;
    }



}