
{include file='header' }
<style type="text/css">
    .layui-btn{
        height: 30px;
        line-height: 30px;
    }
    .layui-btn .layui-icon{
        font-size: 14px;
    }
    .layui-form-label{
        width: auto;
    }
    .btu-color{
        background: #f09c4e;border:none;color: #fff;
    }
    .anjuan{
        font-size: 14px;
        background: antiquewhite;
        font-family: "Songti SC";
        box-shadow: 2px 2px 5px #888888;
        cursor: pointer;
        border-radius: 5px;
    }
    .anjuan .jp{
        padding: 20px 15px;
        text-align: right;
    }
    .anjuan .jp span{
        padding: 5px;
        border: 1px solid #000;
    }
    .anjuan .name{
        text-align: center;
        font-size: 24px;
        padding: 0 10px;
        font-weight: bold;
    }
    .anjuan .wenj{
        padding: 10px 10px 0;
    }
    .anjuan .wenj .xiahua{
        padding: 0 5px;
    }
    .action{
        text-align: center;
        padding: 10px 0;
        border-top: 1px solid #000;
        margin-top: 10px;
        font-size: 14px;
    }
    .batch{
        background: #1dc5a3;border:none;color: #fff;
    }
    .action a{
        padding: 0 5px;
    }
    .title1{
        font-weight: bold;
    }
    .layui-container{
        padding: 0 15px 0 0;
    }
    #pagediv{
        text-align: center;
    }
    #pagestyle{
        position: absolute;
        right: 50px;
        margin-top: -50px;
    }
    .thisstyle{
        background: bisque;
    }
</style>
<div class="contetnBox">
    {include file='layout' }
    <div class="rightBox fl_right">
        <div class="titleBox">
            <div class="title fl_left">案卷管理</div>
        </div>
        <div class="" style="background: white ; padding: 15px;">

            <div class="layui-tab">

                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <form class="layui-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label">姓　名</label>
                                    <div class="layui-input-inline">
                                        <input class="layui-input" name="name" id="name" autocomplete="off">

                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">学　号</label>
                                    <div class="layui-input-inline">
                                        <input class="layui-input" name="sc_number" id="sc_number" autocomplete="off">

                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">卷　号</label>
                                    <div class="layui-input-inline">
                                        <input class="layui-input" name="file_number" id="file_number" autocomplete="off">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">身份证</label>
                                    <div class="layui-input-inline">
                                        <input class="layui-input" name="card" id="card" autocomplete="off">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">手机号</label>
                                    <div class="layui-input-inline">
                                        <input class="layui-input" name="phone" id="phone" autocomplete="off">
                                    </div>
                                </div>

                                <div class="layui-inline">
                                    <label class="layui-form-label">年　级</label>
                                    <div class="layui-input-inline">
                                        <select name="grade" lay-filter="grade"  id="grade">
                                            <option value="" selected>请选择年级</option>
                                            {for start="(date('Y'))" end="1999" comparison="gt" step="-1"}
                                            <option value="{$i}" >{$i}级</option>
                                            {/for}
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">院　系</label>
                                    <div class="layui-input-inline">
                                        <select name="depart" lay-filter="yx" id="depart">
                                            <option value="" selected>请选择院系</option>
                                            {foreach name='departlist' item='v'}
                                            <option value="{$v.id}" >{$v.name}</option>
                                            {/foreach}
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">专　业</label>
                                    <div class="layui-input-inline">
                                        <select name="major"  id="zy">
                                            <option value="">请选专业</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">状　态</label>
                                    <div class="layui-input-inline">
                                        <select name="status" lay-filter="nj" id="status">
                                            <option value="-1" selected>请选择状态</option>
                                            <option value="0" >未接收</option>
                                            <option value="1">在档-正常</option>
                                            <option value="2">借出-外借</option>
                                            <option value="3">已迁出</option>
                                            <option value="4">已退档</option>
                                            <option value="5">转研究生</option>
                                            <option value="6">在档-毕业暂存</option>
                                            <option value="7">在档-村官暂存</option>
                                            <option value="8">借出-室内查阅</option>
                                            <option value="9">借出-在线查阅</option>
                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="layui-form-item" style="text-align: center;">
                                <div class="layui-inline" style="margin-left: 9px">
                                    <a class="layui-btn layui-btn-primary btu-color"  href="javascript:void(0)" id="sch">
                                        <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>搜索
                                    </a>
                                    <a class="layui-btn layui-btn-primary "  href="{:url('/file/getlist')}">
                                        <i class="layui-icon layui-icon-refresh"></i>重置搜索
                                    </a>
                                    <a class="layui-btn layui-btn-primary"  href="JavaScript:void(0)" id="addfile">
                                        <i class="layui-icon layui-icon-add-1 layuiadmin-button-btn"></i>立卷
                                    </a>
                                    <a class="layui-btn layui-btn-primary "  href="JavaScript:void(0)" id="uploadfile">
                                        <i class="layui-icon layui-icon-upload-drag layuiadmin-button-btn"></i>数据导入
                                    </a>
                                    <a class="layui-btn layui-btn-primary "  href="JavaScript:void(0)" id="ccwz">
                                        <i class="layui-icon layui-icon-list layuiadmin-button-btn"></i>生成存储位置
                                    </a>
                                    <!--<a class="layui-btn layui-btn-primary btu-color"  href="{:url('/addExcel')}">批量立卷</a>-->
                                </div>
                            </div>
                        </form>

                        <fieldset class="layui-elem-field layui-field-title">
                            <legend style="text-align:center">案卷列表</legend>
                        </fieldset>
                        <!--<div id="pagestyle" >
                            <div class="layui-btn-group">
                                <a class="layui-btn layui-btn-primary layui-btn-sm " href="{:url('/file/getlist')}"  data-key="0" title="卡片">
                                    <i class="layui-icon">&#xe621;</i>
                                </a>
                                <a class="layui-btn layui-btn-primary layui-btn-sm thisstyle" href="{:url('/file/getlist')}?pagestyle=1"  title="列表"  data-key="1">
                                    <i class="layui-icon">&#xe60a;</i>
                                </a>
                            </div>
                        </div>-->
                        <table class="layui-hide" id="stu_table" lay-filter="stu_table">

                        </table>
                        <script type="text/html" id="doAction">
                            <div class="layui-btn-container">
                                <button class="layui-btn layui-btn-sm"  lay-event="print">打印</button>
                                <button class="layui-btn layui-btn-sm"  lay-event="printCatalogue">打印封面</button>
                                <button class="layui-btn layui-btn-sm"  lay-event="printFill">打印目录</button>
                                <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="printAll">批量打印</button>
                                <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="printAllCatalogue">批量打印封面</button>
                                <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="printAllFill">批量打印目录</button>
                            </div>
                        </script>
                        <script type="text/html" id="oneAction">

                            <a  href="javascript:void(0)" lay-event="showOne">
                                <i class="layui-icon layui-icon-edit"></i>编辑
                            </a>
                            <a  href="javascript:void(0)" lay-event="addfile">
                                <i class="layui-icon layui-icon-add-1"></i>添加
                            </a>
                            <a  href="javascript:void(0)" lay-event="change">
                                <i class="layui-icon layui-icon-engine"></i>变更
                            </a>
                            <a  href="javascript:void(0)" lay-event="list">
                                <i class="layui-icon layui-icon-file"></i>文件
                            </a>
                            <a  href="javascript:void(0)" lay-event="addchange">
                                <i class="layui-icon layui-icon-log"></i>案卷
                            </a
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var table;
    var count=1;
    var limit =  20;

    $(".print").click(function () {
        var id = $(this).data("id");
        layer.open({
            type: 2,
            title:"打印预览-",
            area: ['100%', '100%'],
            fixed: true, //不固定
            maxmin: false,
            scrollbar:false,
            shadeClose:true,
            content: "{:url('/file/print')}?stu_id="+id,
            anim:2
        });
    });

    layui.use('table', function(){
        table = layui.table;

        table.render({
            elem: '#stu_table'
            ,url:"{:url('/file/filelist')}"
            ,toolbar: '#doAction'
            ,defaultToolbar:['filter','exports']
            ,title: '用户数据表'
            ,cols: [[
                {type: 'checkbox', fixed: 'left'}
                ,{field:'file_number', width:120, fixed:true, title:'卷号'}
                ,{field:'name', width:120,fixed:true, title:'姓名',event:"showOne",style:"color:#f09c4e;cursor: pointer;"}
                ,{field:'sex', width:60 , title:'性别'}
                ,{field:'sc_number', width:160, title:'学号'}
                ,{field:'file_derice', width:100, title:'存放位置'}
                ,{field:'dname', width:200, title:'系别-专业'}
                ,{field:'grade',width:80, title:'年级'}
                ,{field:'addtime',width:120, title:'立卷日期'}
                ,{fixed: 'right',field:'file_num',fixed: 'right',width:80, title:'文件数',event:"fileCon",style:"color:#f09c4e;cursor: pointer;"}
                ,{fixed: 'right',field:'status', fixed: 'right',width:120, title:'案卷状态',event:"fileChange",style:"color:#f09c4e;cursor: pointer;"}
                ,{fixed: 'right', toolbar: '#oneAction', minWidth:200, title:'操作'}
            ]]
            ,page: true
            ,limit:10
            ,limits:[10,50,100]
        });
        //单个打印
        table.on('toolbar(stu_table)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id);
            switch(obj.event){
                case 'print':
                    var data = checkStatus.data;
                    layer.open({
                        type: 2,
                        title:"打印预览-",
                        area: ['100%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/print')}?stu_id="+data[0]['id'],
                        anim:2
                    });
                    break;
                case 'printCatalogue':
                    var data = checkStatus.data;
                    layer.open({
                        type: 2,
                        title:"打印预览-",
                        area: ['100%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/printCatalogue')}?stu_id="+data[0]['id'],
                        anim:2
                    });
                    break;
                case 'printFill':
                    var data = checkStatus.data;
                    layer.open({
                        type: 2,
                        title:"打印预览-",
                        area: ['100%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/printFill')}?stu_id="+data[0]['id'],
                        anim:2
                    });
                    break;
                case 'printAllCatalogue':
                    var data = checkStatus.data;
                    var length=data.length;
                    var arr=[];
                    for(var i=0;i<length;i++){
                        var date=data[i]['id'];
                        arr.push(date);

                    }
                    if(arr.length==0){
                        return false;
                    }
                    layer.open({
                        type: 2,
                        title:"打印预览-",
                        area: ['100%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/printAll')}?stu_id="+arr,
                        anim:2
                    });
                    break;
                /*case 'printAll':
                    var data = checkStatus.data;
                    var length=data.length;
                    var arr=[];
                    for(var i=0;i<length;i++){
                        var date=data[i]['id'];
                        arr.push(date);

                    }
                    layer.open({
                        type: 2,
                        title:"打印预览-",
                        area: ['100%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/printAllCatalogue')}?stu_id="+arr,
                        anim:2
                    });
                    break;*/
                case 'printAllFill':
                    var data = checkStatus.data;
                    var length=data.length;
                    var arr=[];
                    for(var i=0;i<length;i++){
                        var date=data[i]['id'];
                        arr.push(date);

                    }
                    if(arr.length==0){
                        return false;
                    }
                    layer.open({
                        type: 2,
                        title:"打印预览-",
                        area: ['100%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/printAllFill')}?stu_id="+arr,
                        anim:2
                    });
                    break;

            }
        });



        table.on('tool(stu_table)', function(obj){
            switch(obj.event){
                case 'fileChange':
                    var  index= layer.open({
                        type: 2,
                        title:"案卷变动-"+obj.data.name,
                        area: ['90%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/change')}?stu_id="+obj.data.id,
                        anim:2
                        ,btn: [ '关闭']//'迁出','降级', '参军', '院系变更','借阅',
                        ,yes: function(index, layero){
                            layer.close(index);
                        }
                    });

                    break;
                case 'fileCon':
                    layer.open({
                        type: 2,
                        title:"文件列表-"+obj.data.name,
                        area: ['90%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/file')}?stu_id="+obj.data.id,
                        anim:2
                    });
                    break;
                case 'showOne':
                    layer.open({
                        type: 2,
                        title:"案卷信息",
                        area: ['80%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/getone')}?id="+obj.data.id,
                        anim:2
                    });
                    break;
                case 'addfile':
                    layer.open({
                        type: 2,
                        title:"添加文件",
                        area: ['60%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/doc/adddoc')}?id="+obj.data.id,
                        anim:2
                    });
                    break;
                case 'chgStatus':

                    layer.open({
                        type: 2,
                        title:"确认收档",
                        area: ['60%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/receivefile')}?id="+obj.data.id,
                        anim:2,
                        cancel: function(index, layero){
                            layer.close(index);
                            window.location.reload();
                        }
                    });

                    break;
                case 'change':
                    layer.open({
                        type: 2,
                        title:"案卷变动",
                        area: ['60%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/changefile')}?id="+obj.data.id,
                        anim:2
                    });
                    break;
                case 'list':
                    layer.open({
                        type: 2,
                        title:"文件列表",
                        area: ['60%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/file')}?stu_id="+obj.data.id,
                        anim:2
                    });
                    break;
                case 'addchange':
                    layer.open({
                        type: 2,
                        title:"案卷变动历史",
                        area: ['60%', '100%'],
                        fixed: true, //不固定
                        maxmin: false,
                        scrollbar:false,
                        shadeClose:true,
                        content: "{:url('/file/change')}?stu_id="+obj.data.id,
                        anim:2
                    });
                    break;
            };
        });
    });
    layui.use(['form'], function(){
        var form = layui.form;
        form.on('select(yx)', function(data){
            var str = '<option value="">请选专业</option>';
            var id = data.value; //院系id
            if(id > 0)
            {
                $.post("{:url('/system/getzy')}",{id:id},function(res){
                    var length = res.length;
                    for (var i=0;i<length;i++) {
                        str += '<option value="'+res[i].id+'">'+res[i].name+'</option>';
                    }
                    layui.$("#zy").html(str);
                    form.render();
                },'json');
            }else{
                layui.$("#zy").html(str);
                form.render();
            }
        });
    });
    $('#sch').click(function(){
        var depart      = $("#depart").val();
        var zy          = $("#zy").val();
        var file_number = $("#file_number").val();
        var sc_number   = $("#sc_number").val();
        var name        = $("#name").val();
        var card        = $("#card").val();
        var phone       = $("#phone").val();
        var grade       = $("#grade").val();
        var status      = $("#status").val();
        table.reload('stu_table', {
            url:"{:url('/file/filelist')}"
            ,page: {
                curr: 1 //重新从第 1 页开始
            }
            ,where: {depart:depart,major:zy,file_number:file_number,sc_number:sc_number,name:name,card:card,phone:phone,grade:grade,status:status} //设定异步数据接口的额外参数
        });
    });
    $("#addfile").click(function () {

        var index = layer.open({
            type: 2,
            title:"立卷",
            area: ['800px', '100%'],
            fixed: true, //不固定
            maxmin: false,
            scrollbar:false,
            shadeClose:false,
            content: "{:url('/file/add')}",
            anim:2,
            cancel: function(index, layero){
                layer.close(index);
                window.location.reload();
            }
        });
    });
    $("#uploadfile").click(function () {

        var index = layer.open({
            type: 2,
            title:"批量导入",
            area: ['600px', '90%'],
            fixed: true, //不固定
            maxmin: false,
            scrollbar:false,
            shadeClose:false,
            content: "{:url('/file/upload')}",
            anim:2,
            cancel: function(index, layero){
                layer.close(index);
                window.location.reload();
            }
        });
    });

    $("#ccwz").click(function () {

        var index = layer.open({
            type: 2,
            title:"生成存储位置",
            area: ['600px', '90%'],
            fixed: true, //不固定
            maxmin: false,
            scrollbar:false,
            shadeClose:false,
            content: "{:url('/file/ccwz')}",
            anim:2,
            cancel: function(index, layero){
                layer.close(index);
                window.location.reload();
            }
        });
    });
    $(".sliderList").removeClass("sliderLists");
    $("#slider2").addClass("sliderLists");
</script>
</body>
</html>
