{include file='header' }
<link rel="stylesheet" type="text/css" href="__STATIC__/css/details.css">
<style type="text/css">
    .layui-btn{
        height: 30px;
        line-height: 30px;
    }
    .layui-btn .layui-icon{
        font-size: 14px;
    }
    .layui-form-label{
        width: auto;
    }
    .btu-color{
        background: #f09c4e;border:none;color: #fff;
    }
    .anjuan{
        font-size: 14px;
        background: antiquewhite;
        font-family: "Songti SC";
        box-shadow: 2px 2px 5px #888888;
        cursor: pointer;
        border-radius: 5px;
    }
    .anjuan .jp{
        padding: 20px 15px;
        text-align: right;
    }
    .anjuan .jp span{
        padding: 5px;
        border: 1px solid #000;
    }
    .anjuan .name{
        text-align: center;
        font-size: 24px;
        padding: 0 10px;
        font-weight: bold;
    }
    .anjuan .wenj{
        padding: 10px 10px 0;
    }
    .anjuan .wenj .xiahua{
        padding: 0 5px;
    }
    .action{
        text-align: center;
        padding: 10px 0;
        border-top: 1px solid #000;
        margin-top: 10px;
        font-size: 14px;
    }
    .batch{
        background: #1dc5a3;border:none;color: #fff;
    }
    .action a{
        padding: 0 5px;
    }
    .title1{
        font-weight: bold;
    }
    .layui-container{
        padding: 0 15px 0 0;
    }
    #pagediv{
        text-align: center;
    }
    #pagestyle{
        position: absolute;
        right: 50px;
        margin-top: -50px;
    }
    .thisstyle{
        background: bisque;
    }
</style>
<div class="contetnBox">
    {include file='layout' }
    <div class="rightBox fl_right">
        <div class="titleBox">
            <!--<div class="title fl_left">案卷管理</div>-->
            {include file='setdoc' title='3' }
        </div>

        <div class="" style="background: white ; padding: 15px;">
            <fieldset class="layui-elem-field ">
                <legend>搜索案卷</legend>
                <div class="layui-field-box">

                    <form class="layui-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <div class="layui-input-inline" style="width: 80px;">
                                <select name="sstype" id="sstype">
                                    <option value="1" selected>学号</option>
                                    <option value="2" >卷号</option>
                                    <option value="3" >身份证</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input class="layui-input" name="number" id="number" autocomplete="off">
                            </div>
                        </div>
                        <div class="layui-inline" >
                            <a class="layui-btn layui-btn-primary btu-color"  href="javascript:void(0)" id="sch">
                                <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>搜索
                            </a>
                        </div>
                    </div>
                    </form>

                    <hr>
                    <div id="stu_div">

                    </div>
                </div>
            </fieldset>
            <fieldset class="layui-elem-field ">
                <legend>选择文件</legend>
                <div class="layui-field-box">
                    <form class="layui-form" action="" lay-filter="myallform">

                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">类　　别：</label>
                                <div class="layui-input-inline">
                                    <select name="category_id" lay-filter="category_id" id="category_id">
                                        <option value=""></option>
                                        {foreach name='c_arr' item='v'}
                                        <option value="{$v.id}" >{$v.name}</option>
                                        {/foreach}
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">文件名称：</label>
                                <div class="layui-input-inline">
                                    <select name="name"  id="name" lay-filter="name"  lay-search>
                                        <option value="">请选择名称</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="layui-form-item">

                            <div class="layui-inline">
                                <label class="layui-form-label">形成日期：</label>
                                <div class="layui-input-inline" style="width: 80px;">
                                    <select name="nian" id="weizhi1">
                                        <option value="" selected>年</option>
                                        {for start="(date('Y'))" end="1999" comparison="gt" step="-1"}
                                        <option value="{$i}" >{$i}</option>
                                        {/for}
                                    </select>
                                </div>
                                <div class="layui-input-inline" style="width: 60px;">
                                    <select name="yue" id="weizhi2">
                                        <option value="" selected>月</option>
                                        {for start="1" end="13" }
                                        <option value="{$i}" >{$i}</option>
                                        {/for}
                                    </select>
                                </div>
                                <div class="layui-input-inline" style="width: 65px;">

                                    <select name="ri" id="weizhi3">
                                        <option value="" selected>日</option>
                                        {for start="1" end="32" }
                                        <option value="{$i}" >{$i}</option>
                                        {/for}
                                    </select>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">文件备注：</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="name_sub" id="name_sub" placeholder="填写附属信息，如年份"  autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">件　　数：</label>
                                <div class="layui-input-inline">
                                    <input type="number" name="item_num" id="item_num"  autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">页　　数：</label>
                                <div class="layui-input-inline">
                                    <input type="number" name="page_num"  id="page_num" lay-verify="page_num" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </div>

                        <div class="layui-form-item"  id="date-div">

                        </div>

                        <div class="layui-form-item">

                            <label class="layui-form-label">附件上传：</label>
                            <div class="layui-input-block">
                                <div class="layui-upload">
                                    <button type="button" class="layui-btn layui-btn-normal" id="testList">选择图片</button>
                                    <div class="layui-upload-list">
                                        <table class="layui-table">
                                            <thead>
                                            <tr><th>文件</th>
                                                <th>大小</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr></thead>
                                            <tbody id="demoList"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="layui-form-item">

                            <label class="layui-form-label">备　　注：</label>
                            <div class="layui-input-block">

                                <textarea placeholder="请输入备注" name="content" id="content" class="layui-textarea"></textarea>
                            </div>
                        </div>
                        <hr>

                        <!--<div class="layui-form-item" style="text-align: center">-->
                            <!--<div class="layui-input-block" style="margin-left: 0px;">-->
                                <!--<input type="hidden" name="student_id" id="student_id" value="" lay-verify="stuid" >-->
                                <!--<button class="layui-btn" lay-submit="" lay-filter="myform">确认添加文件</button>-->
                            <!--</div>-->
                        <!--</div>-->
                    </form>
                    <form class="layui-form" action="{:url('/doc/saveMuch')}" method="post" id="form"lay-filter="myallform">
                        <div>
                            <!--<div class="layui-inline" style="left:50%;">-->
                                <!--<a class="layui-btn  layui-btn-normal " href="javascript:void(0)"  id="sbtn">-->
                                    <!--<i class="layui-icon layui-icon-search layuiadmin-button-btn">提交</i>-->
                                <!--</a>-->
                            <!--</div>-->

                            <div class="layui-form-item" style="text-align: center">
                                <div class="layui-input-block" style="margin-left: 0px;">
                                    <input type="hidden" name="student_id" id="student_id" value="" lay-verify="stuid" >
                                    <input type="hidden" name="data" id="data" value="" lay-verify="atuid" >
                                    <button class="layui-btn layui-btn-primary"  lay-filter="myform" id="btn">暂存</button>
                                    <button class="layui-btn" lay-submit="" lay-filter="myform" id="sbtn">确认添加文件</button>
                                </div>
                            </div>

                            <table class="layui-table"  style="text-align: center;display:none;" id="myTable" lay-size="lg">
                                <colgroup>
                                    <col width="150">
                                    <col width="200">
                                    <col>
                                </colgroup>
                                <thead>
                                <tr id="firTr">
                                    <th style="width: 10%">类别</th>
                                    <th>文件名称</th>
                                    <th>形成日期</th>
                                    <th>文件备注</th>
                                    <th>件数</th>
                                    <th>页数</th>
                                    <th>文件</th>
                                    <th>备注</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </form>


                </div>
            </fieldset>
        </div>
    </div>
</div>
<script type="application/javascript">
    var laydate;
    layui.use('laydate', function(){
        laydate = layui.laydate;
        laydate.render({
            elem: '#within_time' //指定元素
        });
        laydate.render({
            elem: '#formal_time' //指定元素
        });
    });
    layui.use(['form'], function(){
        var form = layui.form;
        form.on('select(category_id)', function(data){
            var str = '<option value="">请选择名称</option>';
            var id = data.value; //院系id
            if(id > 0)
            {
                $.post("{:url('/system/getcategorylist')}",{id:id},function(res){
                    var length = res.length;
                    for (var i=0;i<length;i++) {
                        str += '<option value="'+res[i].name+'">'+res[i].name+'</option>';
                    }
                    layui.$("#name").html(str);
                    form.render();
                },'json');
            }else{
                layui.$("#name").html(str);
                form.render();
            }

        });
        form.on('select(name)', function(data){
            var id = data.value; //院系id
            if(id == "入党志愿书")
            {
                var str = '<div class="layui-inline">';
                str     += '<label class="layui-form-label">正式党员：</label>';
                str     += '<div class="layui-input-inline">';
                str     += '<input type="text" name="formal_time" id="formal_time"  lay-verify="required|date" autocomplete="off" class="layui-input">';
                str     += '</div>';
                str     += '</div>';
                $("#date-div").html(str);

                laydate.render({
                    elem: '#formal_time' //指定元素
                });

            }else{
                var str = '';
                $("#date-div").html(str);
            }
        });
        form.verify({
            vdate: function(value, item){ //value：表单的值、item：表单的DOM对象
                if(value != "")
                {
                    if(!/^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$/.test(value)){
                        return '日期格式错误';
                    }
                }

            },
            stuid: function(value, item){ //value：表单的值、item：表单的DOM对象
                /*if(value == "")
                {
                    return '请搜索到指定学员信息后添加文件';

                }*/

            }
        });
    });


    //上传
    layui.use('upload', function(){
        var $ = layui.jquery
            ,upload = layui.upload;

        //多文件列表示例
        var demoListView = $('#demoList')
            ,uploadListIns = upload.render({
            elem: '#testList'
            ,url: "{:url('/system/upload')}?range="+(new Date().getTime())
            ,accept: 'images'
            ,multiple: false
            ,data:{
                id: function(){
                    return (new Date().getTime())+""+Math.random().toString(36).substr(2, 15);
                }
            }
            ,choose: function(obj){
                var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                //读取本地文件
                obj.preview(function(index, file, result){
                    var tr = $(['<tr class="btr" id="upload-'+ index +'">'
                        ,'<td><img src="'+result+'" style=" height: 100px" class="bigimg"></td>'
                        ,'<td>'+ (file.size/1014).toFixed(1) +'kb</td>'
                        ,'<td>等待上传</td>'
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));

                    //单个重传
                    tr.find('.demo-reload').on('click', function(){

                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.demo-delete').on('click', function(){
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });

                    demoListView.append(tr);
                });
            }
            ,done: function(res, index, upload){
                if(res.code == 200){ //上传成功
                    var tr = demoListView.find('tr#upload-'+ index)

                        ,tds = tr.children();
                    tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                    tds.eq(3).html('<input type="hidden" name="imgs[]" id="hidden_img" value="'+res.data.src+'">'); //清空操作
                    return delete this.files[index]; //删除文件队列已经上传成功的文件
                }
                this.error(index, upload);
            }
            ,error: function(index, upload){
                var tr = demoListView.find('tr#upload-'+ index)
                    ,tds = tr.children();
                tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
            }
        });


    });

    $('#sch').click(function(){
        var sstype      = $("#sstype").val();
        var number      = $("#number").val();

        var data    = {};
        if(sstype==1)
        {
            data    = {"sc_number":number};
        }else if(sstype == 2){
            data    = {"file_number":number};
        }else{
            data    = {"card":number};
        }
        $.post("{:url('/file/searchSnum')}",data,function(res){
            if(res){
                var  html = "";
                html += "<p>姓名："+res.name+"</p>";
                html += "<p>性别："+res.sex+"</p>";
                html += "<p>卷号："+res.file_number+"</p>";
                html += "<p>学号："+res.sc_number+"</p>";
                html += "<p>院系："+res.dname+"</p>";
                html += "<p>专业："+res.mname+"</p>";
                html += "<p>年级："+res.grade+"</p>";
                html += "<p>身份证："+res.card+"</p>";
                html += "<p>手机号："+res.phone+"</p>";
                html += "<p>存放位置："+(res.file_derice==null?"-":res.file_derice)+"</p>";

                $("#stu_div").html(html);
                $("#student_id").val(res.id);
            }else{
                layer.msg('暂无该学生信息');
            }
        },'json');

    });

    //暂存功能数据表格
    $('#btn').click(function(){
        var category_id=$("#category_id").find("option:selected").text();
        var name      = $("#name").val();
        var nian      = $("#weizhi1").val();
        var yue      = $("#weizhi2").val();
        var ri      = $("#weizhi3").val();
        var date=nian+"-"+yue+"-"+ri;
        var name_sub      = $("#name_sub").val();
        var item_num      = $("#item_num").val();
        /*var arr=$('.bigimg');
        var length=arr.length;
        var url='';
        for(var i=0;i<length;i++){
             url+="<img src='"+arr[i].src+"' id='tab_bigimg'>";
        }*/
        var arr=$('#hidden_img').val();
        var url='';
            url+="<img src='"+arr+"' id='tab_bigimg'>";

        $(".btr").remove();
        var page_num      = $("#page_num").val();
        var content      = $("#content").val();
        var Div = document.getElementById('myTable');
        Div.style.cssText = 'width:100%;display:block;';
            var tableHtml ="";
            tableHtml += "<tr id='tr'>"
            +"<td id='tab_category'>"+category_id+"</td>"
            +"<td id='tab_name'>"+name+"</td>"
            +"<td id='tab_date'>"+date+"</td>"
            +"<td id='tab_sub'>"+name_sub+"</td>"
            +"<td id='tab_item'>"+item_num+"</td>"
                +"<td id='tab_page'>"+page_num+"</td>"
            +'<td id="tab_img">'+url+'</td>'
            +"<td id='tab_content'>"+content+"</td>"
            +"</tr>";
        $("#firTr").after(tableHtml);
    });
    //获取表格中的数据
    $('#sbtn').click(function(){
        var result=get_table_data();
        $("#data").val(JSON.stringify(result));
        $("#form").submit();

    });
    function get_table_data(){

        //var name= $("#name").val();
        var tr=$("#myTable tr");
        var result=[];
        var length=tr.length;
        for(var i=0;i<length;i++){
            var tds=$(tr[i]).find("td");
            var count=tds.length;
            if(count>0){
             result.push({'category_id':$("#category_id").val(),'name':$(tds[1]).html(),'date':$(tds[2]).html(),
                 'name_sub':$(tds[3]).html(),'item_num':$(tds[4]).html(),'page_num':$(tds[5]).html(),'enclo':$(tds[6]).find("img")[0].src,
                 'content':$(tds[7]).html()});
            }
        }
        return result;

    }
</script>
</body>
</html>