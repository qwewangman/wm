<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>北京舞蹈学院学生档案管理系统</title>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/records.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/details.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/font/iconfont.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/style.css">

    <script src="__STATIC__/js/jquery-2.1.1.min.js"></script>
    <script src="__STATIC__/layui/layui.js" charset="utf-8"></script>
    <script src="__STATIC__/js/index.js"></script>
    <style>
        .layui-tab-title{position:relative;left:0;height:40px;white-space:nowrap;font-size:0;border-bottom-width:1px;border-bottom-style:solid;transition:all .2s;-webkit-transition:all .2s;width:500px;margin: 0 auto}
        .layui-btn-disableds{
            border: 1px solid #e6e6e6;
            background-color: #FBFBFB;
            color: #C9C9C9;
            cursor: not-allowed;
            opacity: 1;
            height: 28px;
            line-height: 28px;
            padding: 0 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
<div class="hederBox">
    <div class="fl_left logo">北京舞蹈学院学生档案管理系统</div>
    <div class="fl_right">
        <div class="fl_left user">管理员</div>
        <a href="{:url('/login_out')}"  style="color: white"><div class="fl_right signOut">退出</div></a>
        <div class="clear"></div>
    </div>
    <div class="clear"></div>
</div>
<div class="contetnBox">
    {include file='layout'}
    <div class="rightBox fl_right">
        <div class="titleBox">
            <div class="title fl_left">批量接收</div>
            <a href="{:url('/ajgl')}"><div class="fl_right back">返回</div></a>
            <div class="clear"></div>
        </div>
        <div class="" style="background: white ; padding: 10px 30px; overflow: hidden;">
            <!------------------------------------------------------------------------------------------------------------------->
            <div class="layui-tab">
                <div class="layui-tab-content">
                    <!--                个人                    -->
                    <div class="deaHead jb_info">基本信息</div>
                    <div class="layui-tab-item layui-show">
                        <form class="layui-form"  >
                            <div style="margin-left: -30px" class="demoTable">
                                <label class="layui-form-label">院系专业</label>
                                <div class="layui-input-inline">
                                    <select name="courtyard" lay-filter="yx" id="courtyard">
                                        <option value="" selected>请选择院系</option>
                                        {foreach name='departlist' item='v'}
                                        <option value="{$v.id}" >{$v.d_name}</option>
                                        {/foreach}
                                    </select>
                                </div>
                                <div class="layui-input-inline">
                                    <select name="major"  id="zx">
                                        <option value="">请选专业</option>
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux"></div>
                                学号：
                                <div class="layui-inline">
                                    <input class="layui-input" name="sc_number" id="sc_number" autocomplete="off">
                                </div>
                                姓名：
                                <div class="layui-inline">
                                    <input class="layui-input" name="user_name" id="user_name" autocomplete="off">
                                </div>
                                <!--<button class="layui-btn" data-type="reload">搜索</button>-->
                                <div class="layui-btn" data-type="reload" style="width: 100px">搜索</div>
                            </div>
                        </form>
                        <div class="tableBox">
                            <input type="hidden" value="{$id}" id="user_id">
                        <table class="layui-hide" id="LAY_table_user" lay-filter="demo">

                        </table>
                        <script type="text/html" id="barDemo">
                            <a href='#'>   <button lay-event="del" >文件录入</button></a>
                        </script>
                        </div>
                            <span>
                                <button class="layui-btn layui-btn-primary" id="dy" style="background: #f09c4e;border: none">
                    <a href="#" style="color: #fff;">批量接收</a></button>
                            </span>
                        <script>
                            layui.use(['form', 'laydate','upload'], function(){
                                var form = layui.form;
                                form.on('select(yx)', function(data){
                                    var str = '<option value="0">请选专业</option>';
                                    var id = data.value; //院系id
                                    $.post("{:url('/getZy')}",{id:id},function(res){
                                        var length = res.length;
                                        for (var i=0;i<length;i++) {
                                            str += '<option value="'+res[i].id+'">'+res[i].m_name+'</option>';
                                        }
                                        layui.$("#zx").html(str);
                                        form.render();
                                    },'json');
                                });
                            });

                            var id = '';
                            function get_query_str(){
                                var location_url = window.location.href;
                                var parameter_str = location_url.split('?')[1];
                                parameter_str = parameter_str.split('#')[0];
                                var $_GET = {};
                                var parameter_arr = parameter_str.split('&');
                                var tmp_arr;
                                for(var i = 0, len = parameter_arr.length; i <= len -1; i++){
                                    tmp_arr = parameter_arr[i].split('=');
                                    $_GET[tmp_arr[0]] = decodeURIComponent(tmp_arr[1]);
                                }
                                return $_GET;
                            }
                            var data = get_query_str();
                            //用户id
                            id = data.id;
                            //批量接收按钮
                            $('#dy').click(function()
                            {
                                    if (ids != '' && idss != 'end'){
                                        var url = "{:url('/updZd')}?dyid="+ids;
                                        window.location.href = url;
                                    }else{
                                        layer.msg('请先选择案卷！！');
                                        idss = '';
                                        return false;
                                    }
                            });
                            var ids =[];
                            var idss = '';
                            layui.use('table', function(){
                                var table = layui.table;
                                //监听表格复选框选择
                                table.on('checkbox(demo)', function(obj){
                                    if(obj.checked == true)
                                    {
                                            if (obj.data.id == undefined){
                                                idss = '';
                                                arr = id.split(',');
                                                ids = arr;
                                            }else{
                                                idss = '';
                                                k = ids.length;
                                                ids[k]= obj.data.id;
                                            }
                                    }else{
                                        if (obj.type == 'all'){
                                            idss = 'end';
                                            ids = [];
                                        }else{
                                                idss = '';
                                                var n = [];
                                                var kk =0;
                                                for(var i=0 ;i<ids.length ;i++)
                                                {
                                                    if(obj.data.id != ids[i])
                                                    {
                                                        n[kk] =ids[i];
                                                        kk++
                                                    }
                                                }
                                                ids = n;
                                        }
                                    }
                                });
//                                -------------------------------------------------------------------

           //方法级渲染
                                table.render({
                                    elem: '#LAY_table_user'
                                    ,url: "{:url('/getWzd')}?id="+id
                                    ,cols: [[
                                        {checkbox: true, fixed: true}
                                        ,{field:'user_name', title: '姓名'}
                                        ,{field:'sc_number', title: '学号'}
                                        ,{field:'d_name', title: '院系'}
                                        ,{field:'m_name', title: '专业'}
                                        ,{field:'grade', title: '年级'}
                                        ,{field:'class', title: '班级'}
                                        ,{field:'teacher', title: '导师'}
                                        ,{field:'status', title: '状态'}
                                        ,{field:'url', title: '操作'}
                                    ]]
                                    ,id: 'testReload'
                                    ,page: true
                                });
                                var $ = layui.$, active = {
                                    reload: function(){
                                        var courtyard = $('#courtyard');
                                        var zx = $('#zx');
                                        var sc_number = $('#sc_number');
                                        var user_name = $('#user_name');
                                        //执行重载
                                        table.reload('testReload', {
                                            page: {
                                                curr: 1 //重新从第 1 页开始
                                            }
                                            ,where: {
                                                key: {
                                                    courtyard: courtyard.val(),
                                                    major: zx.val(),
                                                    sc_number: sc_number.val(),
                                                    user_name: user_name.val()
                                                }
                                            }
                                        });
                                    }
                                };
                                $('.demoTable .layui-btn').on('click', function(){
                                    var type = $(this).data('type');
                                    active[type] ? active[type].call(this) : '';
                                });
                            });
                        </script>
                    </div>
                </div>
            </div>
            <!-------------------------------------------------javascript------------------------------------------------------------------>
            <!--<script>

                layui.use(['form', 'laydate','upload'], function(){
                    var form = layui.form;
                    form.on('select(yx)', function(data){
                        var str = '<option value="0">请选专业</option>';
                        var id = data.value;
                        $.post("{:url('/getZy')}",{id:id},function(res){
                            var length = res.length;
                            for (var i=0;i<length;i++) {
                                str += '<option value="'+res[i].id+'">'+res[i].m_name+'</option>';
                            }
                            layui.$("#zx").html(str);
                            form.render();
                        },'json');
                    });
                })
                    layui.use('element', function(){
                    var $ = layui.jquery
                            ,element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
                    //触发事件
                    var active = {
                        tabAdd: function(){
                            //新增一个Tab项
                            element.tabAdd('demo', {
                                title: '新选项'+ (Math.random()*1000|0) //用于演示
                                ,content: '内容'+ (Math.random()*1000|0)
                                ,id: new Date().getTime() //实际使用一般是规定好的id，这里以时间戳模拟下
                            })
                        }
                        ,tabDelete: function(othis){
                            //删除指定Tab项
                            element.tabDelete('demo', '44'); //删除：“商品管理”


                            othis.addClass('layui-btn-disabled');
                        }
                        ,tabChange: function(){
                            //切换到指定Tab项
                            element.tabChange('demo', '22'); //切换到：用户管理
                        }
                    };

                    $('.site-demo-active').on('click', function(){
                        var othis = $(this), type = othis.data('type');
                        active[type] ? active[type].call(this, othis) : '';
                    });

                    //Hash地址的定位
                    var layid = location.hash.replace(/^#test=/, '');
                    element.tabChange('test', layid);

                    element.on('tab(test)', function(elem){
                        location.hash = 'test='+ $(this).attr('lay-id');
                    });
                });
            </script>-->

            <div class="contetnBox">

                <div class="rightBox fl_right">
                    <div class="titleBox">

                        <div class="clear"></div>
                    </div>

                    <!--<div class="details">-->
                    <div class="newRightBox">
                        <div style="width: 80% ; margin-left: -225px;">
                            <div class="deaHead jn_text"><span>卷内文件</span></div>
                            <!------------------------------------------------------------------------------------------------------------------->
                            <form class="layui-form" action="{:url('/addFileW')}" method="post">
                                <div style="margin-left: -30px" class="layui-form-item">
                                    <label class="layui-form-label">材料名称</label>
                                    <div class="layui-input-inline">
                                        <select name="within_type"   lay-filter="yy" id="within_type">
                                            <option value=""> 选择 </option>
                                            {foreach name='c' item='v'}
                                            <option value="{$v.id}" >{$v.class_name}</option>
                                            {/foreach}
                                        </select>
                                    </div>
                                    <div class="layui-input-inline">
                                        <select name="within_name"   id="zz">
                                            <option value="">选择</option>
                                        </select>
                                    </div>
                                    <div href="#" class="layui-btn" data-type="reload" style="width: 100px" id="sub">搜索</div>
                                    <div class="layui-form-mid layui-word-aux"></div>
                                </div>
                            </form>
                                <table class="layui-hide" id="test">
                                </table>
                            <span>
                                <button class="layui-btn layui-btn-primary" id="s" style="background: #f09c4e;border: none"><a
                                        href="#" style="color: #fff;">确定接收</a></button>
                            </span>

                            <input type="hidden" id="ids" value="{$id}"/>
                            <script type="text/html" id="checkboxTpl">
                                <input type="checkbox" name="lock" value="{{d.id}}" title="接收" lay-filter="lockDemo" >
                            </script>
                            <script>
                                var id = $("#ids").val();
                                layui.use(['form', 'laydate','upload'], function(){
                                    var form = layui.form;
                                    form.on('select(yy)', function(data){
                                        var str = '<option value="0">请选</option>';
                                        var id = data.value;
                                        $.post("{:url('/getZcl')}",{id:id},function(res){
                                            var length = res.length;
                                            for (var i=0;i<length;i++) {
                                                str += '<option value="'+res[i].id+'">'+res[i].class_num+ '.'+ res[i].class_name+'</option>';
                                            }
                                            layui.$("#zz").html(str);
                                            form.render();
                                        },'json');
                                    });
                                });
                                layui.use('table', function(){
                                    var url = "{:url('/getShInside')}?id="+id;
                                    var table = layui.table
                                        ,form = layui.form;
                                    table.render({
                                        elem: '#test'
                                        ,url: url
                                        ,cellMinWidth: 80
                                        ,cols: [[
                                            {field:'user_name', title:'姓名'}
                                            ,{field:'within_number', title:'件号'}
                                            ,{field:'lb_name', title:'文件类别', templet: '#usernameTpl'}
                                            ,{field:'wh_name', title:'文件目录'}
                                            ,{field:'within_time', title: '形成时间'}
                                            ,{field:'within_num', title:'件数'}
                                            ,{field:'page_num', title:'页数'}
                                            ,{field:'lock', title:'操作', width:110, templet: '#checkboxTpl', unresize: true}
                                        ]]
                                        ,page: true
                                    });
                                    //监听性别操作
                                    form.on('switch(sexDemo)', function(obj){
                                        layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
                                    });

                                    var standards = '';
                                    //监听锁定操作
                                    form.on('checkbox(lockDemo)', function(obj){
//                                    layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
                                        $("input:checkbox[name='lock']:checked").each(function() { // 遍历name=standard的多选框
                                            standards += ',' + $(this).val();
                                        });
                                    });
                                    $('#s').click(function()
                                    {
                                        $.post("{:url('/sHenHe')}",{id:standards},function(res){
                                            if(res.code == 1)
                                            {
                                                alert('接收成功');
                                                history.go(0);
                                            }else{
                                                layer.msg('请先选择文件！！');
                                                return false;
                                            }
                                            form.render();
                                        },'json');
                                    });
                                    $('#sub').click(function () {
                                        var id = $('#zz').val();
                                        if (id == 0){
                                            return false;
                                        }
                                        var url = "{:url('/getShInside')}?within_name="+id;
                                        var table = layui.table
                                            ,form = layui.form;
                                        table.render({
                                            elem: '#test'
                                            ,url: url
                                            ,cellMinWidth: 80
                                            ,cols: [[
                                                 {field:'within_number', title:'件号'}
                                                ,{field:'user_name', title:'姓名'}
                                                ,{field:'lb_name', title:'文件类别', templet: '#usernameTpl'}
                                                ,{field:'wh_name', title:'文件目录'}
                                                ,{field:'within_time', title: '形成时间'}
                                                ,{field:'within_num', title:'件数'}
                                                ,{field:'page_num', title:'页数'}
                                                ,{field:'lock', title:'操作', width:110, templet: '#checkboxTpl', unresize: true}
                                            ]]
                                            ,page: true
                                        });
                                        $('#s').click(function()
                                        {
                                            $.post("{:url('/sHenHe')}",{id:standards},function(res){
                                                if(res.code == 1)
                                                {
                                                    alert('接收成功');
                                                    history.go(0)
                                                }
                                                form.render();
                                            },'json');
                                        })
                                    });
                                });
                            </script>

            <!------------------------------------------------------javascriptEnd------------------------------------------------------------->
        </div>
    </div>

</div></div>
            <div class="deaHead da_state">档案记录</div>
            <div class="tableBox">
                <table cellspacing="0" cellpadding="0" class="layui-hide" id="file_status">

                </table>
                <input type="hidden" id="id_history" value="{$id}"/>
            </div>
            <script>
                layui.use('table', function(){
                    var id = $('#id_history').val();
                    var url = "{:url('/getShInsides')}?id="+id;
                    var table = layui.table
                        ,form = layui.form;
                    table.render({
                        elem: '#file_status'
                        ,url: url
                        ,cols: [[
                            {field:'user_name',title:'姓名'}
                            ,{field:'within_number',title:'件号'}
                            ,{field:'lb_name', title:'文件类别', templet: '#usernameTpl'}
                            ,{field:'wh_name', title:'文件目录'}
                            ,{field:'within_time', title: '形成时间'}
                            ,{field:'within_num', title:'件数'}
                            ,{field:'page_num', title:'页数'}
                            ,{field:'status',title:'状态'}
                        ]]
                        ,page: true
                    });
                });
            </script>
</body>
</html>
